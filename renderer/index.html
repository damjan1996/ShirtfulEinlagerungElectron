<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' 'unsafe-inline' 'unsafe-eval';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdnjs.cloudflare.com;
        media-src 'self' blob: data: mediastream:;
        connect-src 'self' blob: data:;
        img-src 'self' blob: data: https:;
        style-src 'self' 'unsafe-inline';
    ">
    <title>RFID Wareneinlagerung mit QualitÃ¤tskontrolle - Shirtful</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<!-- Header -->
<header class="main-header">
    <div class="header-content">
        <div class="company-info">
            <h1 class="app-title">ğŸ“¦ Wareneinlagerung + QC</h1>
            <div class="company-name">Shirtful GmbH</div>
        </div>

        <div class="system-status">
            <div class="status-indicator" id="systemStatus">
                <div class="status-dot"></div>
                <span class="status-text">System wird gestartet...</span>
            </div>
            <!-- QC-System-Status -->
            <div class="status-indicator qc-status" id="qcSystemStatus" style="display: none;">
                <div class="status-dot qc"></div>
                <span class="status-text">QC bereit</span>
            </div>
            <div class="current-time" id="currentTime">--:--:--</div>
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="main-content">
    <!-- Login Bereich -->
    <section class="login-section" id="loginSection">
        <div class="login-card">
            <div class="login-icon">ğŸ·ï¸</div>
            <h2>RFID-Tag scannen</h2>
            <p>Halten Sie Ihren RFID-Tag an den Scanner</p>
            <div class="login-status" id="loginStatus">
                <div class="pulse-animation"></div>
                Bereit zum Scannen...
            </div>
            <div class="login-info">
                <p>ğŸ’¡ Mehrere Mitarbeiter kÃ¶nnen gleichzeitig arbeiten</p>
                <p>ğŸ”„ Erneutes Scannen startet Ihre Session neu</p>
                <p>ğŸ” <strong>NEU:</strong> Doppelte QR-Scans fÃ¼r QualitÃ¤tskontrolle</p>
            </div>
        </div>
    </section>

    <!-- Arbeitsbereich (nur sichtbar wenn Benutzer angemeldet) -->
    <section class="workspace" id="workspace" style="display: none;">

        <!-- Aktive Benutzer Sidebar -->
        <div class="users-sidebar">
            <div class="sidebar-header">
                <h3>ğŸ‘¥ Aktive Mitarbeiter</h3>
                <span class="user-count" id="activeUserCount">0</span>
            </div>
            <div class="users-list" id="activeUsersList">
                <!-- Dynamisch gefÃ¼llte Benutzer-Liste -->
            </div>
        </div>

        <!-- QC-Panel (wird dynamisch hinzugefÃ¼gt durch qc-manager.js) -->
        <div class="qc-panel" id="qcPanel" style="display: none;">
            <div class="qc-header">
                <h3>ğŸ” QualitÃ¤tskontrolle</h3>
                <div class="qc-status" id="qcStatus">
                    <span class="qc-status-dot active"></span>
                    <span class="qc-status-text">System bereit</span>
                </div>
            </div>

            <div class="qc-content">
                <!-- Aktive QC-Schritte -->
                <div class="qc-section">
                    <div class="qc-section-header">
                        <h4>ğŸ“‹ Aktive QC-Schritte</h4>
                        <span class="qc-counter" id="activeQCCounter">0</span>
                    </div>
                    <div class="qc-steps-list" id="qcStepsList">
                        <div class="qc-no-steps">Keine aktiven QC-Schritte</div>
                    </div>
                </div>

                <!-- QC-Statistiken -->
                <div class="qc-section">
                    <div class="qc-section-header">
                        <h4>ğŸ“Š QC-Statistiken</h4>
                        <button class="btn-small qc-refresh-btn" id="qcRefreshBtn">ğŸ”„</button>
                    </div>
                    <div class="qc-statistics" id="qcStatistics">
                        <div class="qc-stat">
                            <span class="qc-stat-label">Abgeschlossen heute:</span>
                            <span class="qc-stat-value" id="qcCompletedToday">0</span>
                        </div>
                        <div class="qc-stat">
                            <span class="qc-stat-label">Durchschnittsdauer:</span>
                            <span class="qc-stat-value" id="qcAvgDuration">0 Min</span>
                        </div>
                        <div class="qc-stat">
                            <span class="qc-stat-label">Abschlussrate:</span>
                            <span class="qc-stat-value" id="qcCompletionRate">0%</span>
                        </div>
                    </div>
                </div>

                <!-- ÃœberfÃ¤llige Warnungen -->
                <div class="qc-section qc-overdue-section" id="qcOverdueSection" style="display: none;">
                    <div class="qc-section-header">
                        <h4>âš ï¸ ÃœberfÃ¤llige QC-Schritte</h4>
                        <span class="qc-counter warning" id="overdueQCCounter">0</span>
                    </div>
                    <div class="qc-overdue-list" id="qcOverdueList"></div>
                </div>
            </div>
        </div>

        <!-- Hauptarbeitsbereich -->
        <div class="main-work-area">
            <!-- AusgewÃ¤hlter Benutzer Info -->
            <div class="selected-user-panel" id="selectedUserPanel" style="display: none;">
                <div class="user-info">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <div class="user-details">
                        <h3 class="user-name" id="selectedUserName">Kein Benutzer ausgewÃ¤hlt</h3>
                        <div class="user-session-info">
                            <span class="session-time" id="selectedSessionTime">00:00:00</span>
                            <span class="session-scans">â€¢ <span id="selectedSessionScans">0</span> Scans</span>
                            <!-- QC-Info fÃ¼r ausgewÃ¤hlten Benutzer -->
                            <span class="session-qc-info" id="selectedSessionQCInfo" style="display: none;">
                                â€¢ <span id="selectedSessionQC">0</span> QC aktiv
                            </span>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="logout-btn" id="selectedUserLogout" title="Abmelden">
                            <span>ğŸ”“</span>
                            Abmelden
                        </button>
                    </div>
                </div>
            </div>

            <!-- QR-Scanner Bereich -->
            <div class="scanner-section">
                <div class="scanner-header">
                    <h3>ğŸ“¸ QR-Code Scanner</h3>
                    <div class="scanner-info-bar">
                        <span id="scannerUserInfo">WÃ¤hlen Sie einen Mitarbeiter aus</span>
                        <!-- QC-Modus-Anzeige -->
                        <span class="qc-mode-indicator" id="qcModeIndicator" style="display: none;">
                            ğŸ” QC-Modus aktiv
                        </span>
                    </div>
                    <div class="scanner-controls">
                        <button class="btn-primary" id="startScannerBtn">
                            ğŸ“¹ Scanner starten
                        </button>
                        <button class="btn-secondary" id="stopScannerBtn" style="display: none;">
                            â¹ï¸ Scanner stoppen
                        </button>
                        <!-- QC-Modus Toggle -->
                        <button class="btn-qc-toggle" id="qcModeToggle" style="display: none;" title="QC-Modus umschalten">
                            ğŸ” QC
                        </button>
                    </div>
                </div>

                <!-- Kamera-Vorschau -->
                <div class="camera-container" id="cameraContainer">
                    <video id="scannerVideo" autoplay playsinline muted></video>
                    <div class="scanner-overlay">
                        <div class="scanner-frame"></div>
                        <div class="scan-target">
                            <div class="corner tl"></div>
                            <div class="corner tr"></div>
                            <div class="corner bl"></div>
                            <div class="corner br"></div>
                        </div>
                        <!-- QC-Overlay-Indikator -->
                        <div class="qc-scan-overlay" id="qcScanOverlay" style="display: none;">
                            <div class="qc-scan-message">
                                <div class="qc-scan-icon">ğŸ”</div>
                                <div class="qc-scan-text" id="qcScanText">QC-Schritt 1: Eingang scannen</div>
                            </div>
                        </div>
                    </div>
                    <div class="camera-status" id="cameraStatus">
                        <div class="status-icon">ğŸ“·</div>
                        <div class="status-text">Klicken Sie "Scanner starten"</div>
                    </div>
                </div>
                <canvas id="scannerCanvas" style="display: none;"></canvas>

                <!-- Scanner-Info -->
                <div class="scanner-info">
                    <div class="info-row">
                        <span class="info-label">Status:</span>
                        <span class="info-value" id="scannerStatusText">Bereit</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Letzter Scan:</span>
                        <span class="info-value" id="lastScanTime">-</span>
                    </div>
                    <!-- QC-spezifische Info -->
                    <div class="info-row qc-info-row" id="qcInfoRow" style="display: none;">
                        <span class="info-label">QC-Status:</span>
                        <span class="info-value" id="qcStatusInfo">Bereit</span>
                    </div>
                </div>
            </div>

            <!-- QR-Scans Ãœbersicht -->
            <div class="recent-scans-section">
                <div class="scans-header">
                    <h3>ğŸ“‹ QR-Scans</h3>
                    <div class="scans-controls">
                        <button class="btn-secondary btn-small" id="clearScansBtn">ğŸ—‘ï¸ Leeren</button>
                        <button class="btn-secondary btn-small" id="refreshScansBtn">ğŸ”„ Aktualisieren</button>
                        <!-- QC-Filter -->
                        <button class="btn-secondary btn-small qc-filter-btn" id="qcFilterBtn" style="display: none;">
                            ğŸ” Nur QC
                        </button>
                    </div>
                </div>

                <!-- Aktueller Scan -->
                <div class="current-scan-display" id="currentScanDisplay" style="display: none;">
                    <div class="current-scan-header">
                        <span class="current-scan-time" id="currentScanTime">--:--:--</span>
                        <span class="current-scan-status" id="currentScanStatus">
                            <span class="status-icon">ğŸ“„</span>
                            <span class="status-text">Aktueller Scan</span>
                        </span>
                    </div>
                    <div class="current-scan-content" id="currentScanContent">Noch kein QR-Code gescannt</div>
                    <div class="current-scan-message" id="currentScanMessage">Scannen Sie einen QR-Code</div>

                    <!-- QC-spezifische Anzeige -->
                    <div class="current-scan-qc-info" id="currentScanQCInfo" style="display: none;">
                        <div class="qc-step-info">
                            <span class="qc-step-label" id="qcStepLabel">QC-Schritt:</span>
                            <span class="qc-step-value" id="qcStepValue">1/2 (Eingang)</span>
                        </div>
                        <div class="qc-duration-info" id="qcDurationInfo">
                            <span class="qc-duration-label">Dauer:</span>
                            <span class="qc-duration-value" id="qcDurationValue">0 Min</span>
                        </div>
                        <div class="qc-next-step" id="qcNextStep">
                            Scannen Sie den gleichen QR-Code erneut fÃ¼r Ausgang
                        </div>
                    </div>
                </div>

                <!-- Erfolgreich gescannte Pakete - Tabellenansicht -->
                <div class="success-scans-table-container">
                    <table class="success-scans-table" id="successScansTable">
                        <thead>
                        <tr>
                            <th class="scan-time-col">Zeit</th>
                            <th class="user-col">Mitarbeiter</th>
                            <th class="auftrag-col">Auftrags-ID</th>
                            <th class="kunde-col">Kunden-ID</th>
                            <th class="paket-col">Paket-ID</th>
                            <!-- QC-Spalte -->
                            <th class="qc-col" id="qcColumn" style="display: none;">QC</th>
                        </tr>
                        </thead>
                        <tbody id="successScansTableBody">
                        <!-- Erfolgreiche Scans werden hier eingefÃ¼gt -->
                        </tbody>
                    </table>

                    <div class="empty-scans" id="emptySuccessScans">
                        <div class="empty-icon">ğŸ“¦</div>
                        <p>Noch keine Pakete erfolgreich gescannt</p>
                        <p class="qc-hint" id="qcHint" style="display: none;">
                            ğŸ” Mit QC: Scannen Sie jeden QR-Code zweimal fÃ¼r vollstÃ¤ndige QualitÃ¤tsprÃ¼fung
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<!-- Footer -->
<footer class="main-footer">
    <div class="footer-content">
        <div class="footer-left">
            <span id="instructionText">ğŸ’¡ RFID-Tag scannen = Anmelden â€¢ QR-Code scannen = Paket einlagern â€¢ QC: Doppelt scannen fÃ¼r QualitÃ¤tsprÃ¼fung</span>
        </div>
        <div class="footer-right">
            <span id="versionText">v1.1.0</span>
            <span class="separator">â€¢</span>
            <span id="dateText">--.--.----</span>
            <!-- QC-Indikator im Footer -->
            <span class="separator">â€¢</span>
            <span id="qcFooterStatus" style="display: none;">ğŸ” QC aktiv</span>
        </div>
    </div>
</footer>

<!-- Benachrichtigungen -->
<div class="notifications" id="notifications"></div>

<!-- Error Modal -->
<div class="modal" id="errorModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <span class="icon">âš ï¸</span>
                Fehler
            </h3>
            <button class="modal-close" id="errorModalClose">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="error-message" id="errorMessage"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-primary" id="errorModalOk">OK</button>
        </div>
    </div>
</div>

<!-- Camera Permission Modal -->
<div class="modal" id="cameraPermissionModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <span class="icon">ğŸ“·</span>
                Kamera-Berechtigung
            </h3>
        </div>
        <div class="modal-body">
            <p>Die Anwendung benÃ¶tigt Zugriff auf Ihre Kamera fÃ¼r das QR-Code-Scanning.</p>
            <p>Bitte erlauben Sie den Kamera-Zugriff im nÃ¤chsten Dialog.</p>
        </div>
        <div class="modal-footer">
            <button class="btn-primary" id="grantCameraPermission">Kamera erlauben</button>
            <button class="btn-secondary" id="cancelCameraPermission">Abbrechen</button>
        </div>
    </div>
</div>

<!-- User Logout Confirmation Modal -->
<div class="modal" id="logoutModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <span class="icon">ğŸ”“</span>
                Mitarbeiter abmelden
            </h3>
            <button class="modal-close" id="logoutModalClose">âœ•</button>
        </div>
        <div class="modal-body">
            <p>MÃ¶chten Sie <strong id="logoutUserName"></strong> wirklich abmelden?</p>
            <p class="modal-warning">Die Session wird beendet und alle ungespeicherten Daten gehen verloren.</p>
            <!-- QC-Warnung -->
            <div class="modal-qc-warning" id="logoutQCWarning" style="display: none;">
                <p class="qc-warning-text">âš ï¸ <strong>Achtung:</strong> Dieser Benutzer hat aktive QC-Schritte:</p>
                <ul class="qc-warning-list" id="logoutQCList"></ul>
                <p>Diese QC-Schritte werden abgebrochen!</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-danger" id="confirmLogout">Ja, abmelden</button>
            <button class="btn-secondary" id="cancelLogout">Abbrechen</button>
        </div>
    </div>
</div>

<!-- Session Restart Confirmation Modal -->
<div class="modal" id="sessionRestartModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <span class="icon">ğŸ”„</span>
                Session neu starten
            </h3>
            <button class="modal-close" id="sessionRestartModalClose">âœ•</button>
        </div>
        <div class="modal-body">
            <p>MÃ¶chten Sie die Session von <strong id="restartUserName"></strong> neu starten?</p>
            <p class="modal-info">Der Timer wird zurÃ¼ckgesetzt und die Session beginnt von vorne.</p>
            <!-- QC-Warnung -->
            <div class="modal-qc-warning" id="restartQCWarning" style="display: none;">
                <p class="qc-warning-text">âš ï¸ <strong>Achtung:</strong> Aktive QC-Schritte werden abgebrochen:</p>
                <ul class="qc-warning-list" id="restartQCList"></ul>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-primary" id="confirmSessionRestart">Ja, neu starten</button>
            <button class="btn-secondary" id="cancelSessionRestart">Abbrechen</button>
        </div>
    </div>
</div>

<!-- QC Completion Modal -->
<div class="modal" id="qcCompletionModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <span class="icon">âœ…</span>
                QualitÃ¤tsprÃ¼fung abgeschlossen
            </h3>
            <button class="modal-close" id="qcCompletionModalClose">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="qc-completion-info">
                <div class="qc-completion-qr">
                    <strong>QR-Code:</strong> <span id="qcCompletionQRCode"></span>
                </div>
                <div class="qc-completion-duration">
                    <strong>Dauer:</strong> <span id="qcCompletionDuration"></span> Minuten
                </div>
                <div class="qc-completion-user">
                    <strong>Mitarbeiter:</strong> <span id="qcCompletionUser"></span>
                </div>
            </div>

            <!-- Optional: QualitÃ¤tsbewertung -->
            <div class="qc-rating-section" id="qcRatingSection" style="display: none;">
                <h4>QualitÃ¤tsbewertung (optional):</h4>
                <div class="qc-rating-stars">
                    <button class="qc-star" data-rating="1">â­</button>
                    <button class="qc-star" data-rating="2">â­</button>
                    <button class="qc-star" data-rating="3">â­</button>
                    <button class="qc-star" data-rating="4">â­</button>
                    <button class="qc-star" data-rating="5">â­</button>
                </div>
                <textarea class="qc-notes" id="qcNotes" placeholder="Notizen zur QualitÃ¤tsprÃ¼fung (optional)"></textarea>
            </div>

            <!-- Session-Reset-Option -->
            <div class="qc-session-reset-option" id="qcSessionResetOption">
                <label class="qc-checkbox-label">
                    <input type="checkbox" id="qcAutoSessionReset" checked>
                    Session automatisch beenden nach QC-Abschluss
                </label>
                <p class="qc-reset-info">Empfohlen fÃ¼r optimalen QC-Workflow</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-primary" id="qcCompletionConfirm">QC abschlieÃŸen</button>
            <button class="btn-secondary" id="qcCompletionCancel">Abbrechen</button>
        </div>
    </div>
</div>

<!-- QC Overdue Warning Modal -->
<div class="modal" id="qcOverdueModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <span class="icon">âš ï¸</span>
                QC-Schritte Ã¼berfÃ¤llig
            </h3>
            <button class="modal-close" id="qcOverdueModalClose">âœ•</button>
        </div>
        <div class="modal-body">
            <p>Die folgenden QC-Schritte sind Ã¼berfÃ¤llig:</p>
            <div class="qc-overdue-details" id="qcOverdueDetails"></div>
            <p class="qc-overdue-hint">Bitte scannen Sie die entsprechenden QR-Codes erneut, um die QualitÃ¤tsprÃ¼fung abzuschlieÃŸen.</p>
        </div>
        <div class="modal-footer">
            <button class="btn-primary" id="qcOverdueOk">Verstanden</button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="qc-manager.js"></script>
<script src="app.js"></script>
</body>
</html>